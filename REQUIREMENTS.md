# Ramat システム要件定義書

**プロジェクト名**: Ramat（ラマト）  
**バージョン**: v1.0  
**作成日**: 2025年12月14日  
**最終更新**: 2025年12月14日  
**ステータス**: ✅ MVP完成・本番稼働中

---

## 📋 目次

1. [文書概要](#1-文書概要)
2. [プロジェクト概要](#2-プロジェクト概要)
3. [システム概要](#3-システム概要)
4. [機能要件](#4-機能要件)
5. [非機能要件](#5-非機能要件)
6. [データ要件](#6-データ要件)
7. [外部インターフェース要件](#7-外部インターフェース要件)
8. [セキュリティ要件](#8-セキュリティ要件)
9. [画面要件](#9-画面要件)
10. [API要件](#10-api要件)
11. [制約事項](#11-制約事項)
12. [用語集](#12-用語集)

---

## 1. 文書概要

### 1.1 目的
本文書は、AI対話型メンタルウェルネスアプリケーション「Ramat」のシステム要件を定義する。開発チーム、ステークホルダー、QAチームが共通理解を持ち、品質の高いプロダクト開発を実現することを目的とする。

### 1.2 想定読者
- プロダクトマネージャー
- エンジニア（フロントエンド・バックエンド）
- UI/UXデザイナー
- QAエンジニア
- ステークホルダー

### 1.3 参照文書
- `BUSINESS_PLAN.md` - 事業計画書
- `README.md` - プロジェクト概要
- `TEST_REPORT.md` - テスト報告書

---

## 2. プロジェクト概要

### 2.1 プロジェクトの背景
現代社会における孤独感の増大、メンタルヘルス問題の深刻化を背景に、24時間365日アクセス可能な「AI対話型コンパニオン」の需要が高まっている。Ramatは、この社会課題を解決するため、ユーザー一人ひとりに唯一無二の「ソウルメイト（守護動物）」を提供する。

### 2.2 プロジェクトの目的
1. **孤独感の軽減**: いつでも話せる相手を提供
2. **メンタルウェルネス向上**: 日常的な対話を通じた心のサポート
3. **パーソナライゼーション**: ユーザー固有のキャラクター生成
4. **継続的エンゲージメント**: 長期的な利用を促進

### 2.3 ターゲットユーザー
- **プライマリー**: 20-40代女性（日本国内）
- **セカンダリー**: メンタルヘルスに関心のある全年齢層

### 2.4 成功基準
| 指標 | 目標値（Year 1） |
|-----|----------------|
| MAU（月間アクティブユーザー） | 15,500 |
| 有料転換率 | 12% |
| D7リテンション | 40% |
| NPS（Net Promoter Score） | 30+ |

---

## 3. システム概要

### 3.1 システムの目的
AI技術を活用し、ユーザーごとにパーソナライズされた「ソウルメイト」を生成し、継続的な対話を通じてメンタルウェルネスをサポートするWebアプリケーションを提供する。

### 3.2 システムアーキテクチャ

```
┌─────────────────────────────────────────────────────┐
│                     Client Layer                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   Mobile    │  │   Tablet    │  │  Desktop    │ │
│  │  (WebView)  │  │  (Browser)  │  │  (Browser)  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
                          │
                    HTTPS (TLS 1.3)
                          │
┌─────────────────────────────────────────────────────┐
│              Cloudflare Edge Network                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │   CDN    │  │   WAF    │  │   DDoS   │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────┐
│               Application Layer                      │
│  ┌─────────────────────────────────────────────┐   │
│  │        Cloudflare Workers (Hono)            │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│  │  │   Auth   │  │   Chat   │  │   Admin  │  │   │
│  │  └──────────┘  └──────────┘  └──────────┘  │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
          │               │               │
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Cloudflare  │  │   Gemini    │  │ Cloudflare  │
│   D1 (DB)   │  │  AI API     │  │  R2 (S3)    │
└─────────────┘  └─────────────┘  └─────────────┘
```

### 3.3 技術スタック

#### フロントエンド
| カテゴリ | 技術 | バージョン | 用途 |
|---------|-----|----------|------|
| **言語** | JavaScript (ES6+) | - | クライアントサイドロジック |
| **フレームワーク** | Vanilla JS | - | 軽量・高速化 |
| **スタイリング** | TailwindCSS | 3.x | CDN経由、レスポンシブデザイン |
| **アイコン** | Font Awesome | 6.4.0 | UIアイコン |
| **チャート** | Chart.js | 4.x | 管理者ダッシュボード |

#### バックエンド
| カテゴリ | 技術 | バージョン | 用途 |
|---------|-----|----------|------|
| **ランタイム** | Cloudflare Workers | - | エッジコンピューティング |
| **フレームワーク** | Hono | 4.x | 軽量Webフレームワーク |
| **言語** | TypeScript | 5.x | 型安全な開発 |
| **ビルドツール** | Vite | 6.x | 高速バンドラー |

#### データベース・ストレージ
| カテゴリ | 技術 | 用途 |
|---------|-----|------|
| **メインDB** | Cloudflare D1 | ユーザー、ソウルメイト、チャット履歴 |
| **オブジェクトストレージ** | Cloudflare R2 | 壁紙画像保存 |
| **キャッシュ** | Cloudflare KV | セッション管理（将来実装） |

#### AI/ML
| サービス | モデル | 用途 |
|---------|-------|------|
| **Google Gemini** | gemini-2.0-flash-exp | テキスト生成（プロフィール・チャット） |
| **Google Gemini** | gemini-2.5-flash-image | 画像生成（ソウルメイト画像） |

#### インフラ・デプロイ
| カテゴリ | 技術 | 用途 |
|---------|-----|------|
| **ホスティング** | Cloudflare Pages | 静的サイトホスティング |
| **CDN** | Cloudflare | 200+都市のエッジネットワーク |
| **CI/CD** | Wrangler | デプロイ自動化 |
| **監視** | Cloudflare Analytics | アクセス解析・パフォーマンス監視 |

---

## 4. 機能要件

### 4.1 ユーザー認証機能

#### 4.1.1 新規登録（REQ-AUTH-001）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーがメールアドレスとパスワードで新規アカウントを作成できる |
| **アクター** | 新規ユーザー |
| **前提条件** | なし |
| **入力** | メールアドレス、パスワード、ユーザー名 |
| **処理** | 1. 入力バリデーション<br>2. メールアドレス重複チェック<br>3. パスワードハッシュ化（SHA-256）<br>4. DBへ登録<br>5. JWTトークン発行<br>6. Cookieにトークン保存 |
| **出力** | ユーザー情報、認証トークン |
| **事後条件** | ユーザーがログイン状態になる |
| **例外処理** | - メールアドレス重複: エラーメッセージ表示<br>- バリデーションエラー: 該当フィールドにエラー表示 |

**バリデーションルール:**
- **メールアドレス**: RFC5322準拠の形式
- **パスワード**: 8文字以上、英数字を含む
- **ユーザー名**: 2-20文字

#### 4.1.2 ログイン（REQ-AUTH-002）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | 登録済みユーザーがメールアドレスとパスワードでログインできる |
| **アクター** | 登録済みユーザー |
| **前提条件** | アカウントが存在する |
| **入力** | メールアドレス、パスワード |
| **処理** | 1. メールアドレスでユーザー検索<br>2. パスワードハッシュ照合<br>3. JWTトークン発行<br>4. Cookieに保存<br>5. last_active_at更新 |
| **出力** | ユーザー情報、認証トークン |
| **事後条件** | ユーザーがログイン状態になり、チャットページへリダイレクト |
| **例外処理** | - ユーザー不在: 「メールアドレスまたはパスワードが間違っています」<br>- パスワード不一致: 同上 |

#### 4.1.3 ログアウト（REQ-AUTH-003）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ログイン中のユーザーがログアウトできる |
| **アクター** | ログイン済みユーザー |
| **前提条件** | ログイン状態 |
| **入力** | なし（ボタンクリック） |
| **処理** | 1. 確認ダイアログ表示<br>2. Cookieからトークン削除<br>3. ログインページへリダイレクト |
| **出力** | なし |
| **事後条件** | ユーザーがログアウト状態になる |

#### 4.1.4 セッション管理（REQ-AUTH-004）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーのログイン状態を30日間維持する |
| **処理** | - JWTトークンの有効期限: 30日<br>- HTTP-only Cookieによる保存<br>- ページアクセス時に自動検証<br>- 無効トークンは自動的にログアウト |

---

### 4.2 ソウルメイト生成機能

#### 4.2.1 初回生成（REQ-GEN-001）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーが初めてチャットページにアクセスした際、全画面モーダルでソウルメイトを生成する |
| **アクター** | 新規ユーザー（初回訪問） |
| **前提条件** | ログイン済み、ソウルメイト未生成 |
| **入力** | なし（「ソウルメイトを呼ぶ」ボタンクリック） |
| **処理** | **フェーズ1: 出会いの招待**<br>- モーダル表示<br>- アニメーション効果<br><br>**フェーズ2: 生成処理**<br>1. 動物ランダム選択（75種類）<br>2. 名前ランダム選択（100種類）<br>3. Gemini API: プロフィール生成<br>4. Gemini API: 画像生成<br>5. D1 DBへ保存<br>6. プログレスバー表示（0% → 100%）<br><br>**フェーズ3: 結果表示**<br>- 生成画像表示（フェードイン）<br>- プロフィール表示<br>- 自動挨拶メッセージ送信 |
| **出力** | ソウルメイトプロフィール（名前、コンセプト、性格、口調、画像） |
| **所要時間** | 平均8-10秒 |
| **事後条件** | - ソウルメイトがDBに保存される<br>- チャットページが通常表示に切り替わる<br>- 挨拶メッセージがチャット履歴に追加される |
| **例外処理** | - API エラー: 「生成に失敗しました。もう一度お試しください」<br>- タイムアウト: リトライボタン表示 |

**生成パラメータ:**
```javascript
// プロフィール生成
{
  model: 'gemini-2.0-flash-exp',
  temperature: 1.8,
  maxOutputTokens: 500,
  topP: 0.98,
  topK: 50
}

// 画像生成
{
  model: 'gemini-2.5-flash-image'
}
```

#### 4.2.2 ソウルメイト存在チェック（REQ-GEN-002）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーが既にソウルメイトを持っているか確認する |
| **処理** | 1. D1 DBでsoulmates テーブル検索（user_id）<br>2. 存在する場合: 通常チャット画面表示<br>3. 存在しない場合: 生成モーダル表示 |
| **性能要件** | 応答時間 < 500ms |

---

### 4.3 チャット機能

#### 4.3.1 メッセージ送信（REQ-CHAT-001）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーがソウルメイトにメッセージを送信できる |
| **アクター** | ログイン済みユーザー |
| **前提条件** | ソウルメイト生成済み |
| **入力** | テキストメッセージ（1-500文字） |
| **処理** | 1. 入力バリデーション<br>2. メッセージをDBに保存（sender='user'）<br>3. UIに即座に反映<br>4. タイピングインジケーター表示<br>5. Gemini APIに送信（性格・口調反映）<br>6. AI返答を取得<br>7. 返答をDBに保存（sender='soulmate'）<br>8. UIに返答を表示<br>9. 統計情報更新（メッセージ数+1） |
| **出力** | ソウルメイトからの返答メッセージ |
| **応答時間** | 平均2-3秒 |
| **事後条件** | - チャット履歴がDBに保存される<br>- ユーザー統計が更新される |
| **例外処理** | - API エラー: 「返答の生成に失敗しました」<br>- タイムアウト: リトライボタン表示 |

**チャット生成パラメータ:**
```javascript
{
  model: 'gemini-2.0-flash-exp',
  temperature: 1.2,
  maxOutputTokens: 200,
  topP: 0.95,
  topK: 40
}
```

#### 4.3.2 チャット履歴表示（REQ-CHAT-002）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | 過去のチャット履歴を時系列順に表示する |
| **処理** | 1. DBから過去50件取得（created_at DESC）<br>2. 時系列順にソート<br>3. ユーザー/ソウルメイトを区別して表示<br>4. 最新メッセージまで自動スクロール |
| **表示件数** | 初回50件、スクロールで追加読み込み |
| **性能要件** | 読み込み時間 < 1秒 |

#### 4.3.3 ヘッダー縮小機能（REQ-CHAT-003）
**優先度**: 🟡 推奨

| 項目 | 内容 |
|-----|------|
| **概要** | メッセージ数が3件以上の場合、スクロール時にヘッダー画像を縮小する |
| **処理** | - デフォルト: 200x200px<br>- スクロール検知（50px以上）<br>- 縮小: 60x60px<br>- アニメーション: 0.3秒 |

---

### 4.4 マイページ機能

#### 4.4.1 プロフィール表示（REQ-MYPAGE-001）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ソウルメイトのプロフィール情報を表示する |
| **表示項目** | - 画像（200x200px）<br>- 名前<br>- コンセプト<br>- 動物種<br>- 生成日<br>- 「出会って○日」カウンター |
| **処理** | 1. DBからソウルメイト情報取得<br>2. 日数計算（現在日時 - created_at）<br>3. カード形式で表示 |

#### 4.4.2 統計情報表示（REQ-MYPAGE-002）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーの利用統計を表示する |
| **表示項目** | - 総メッセージ数<br>- 出会った日数<br>- 最終チャット日時<br>- お気に入り数（将来実装） |
| **処理** | 1. user_stats テーブルから取得<br>2. リアルタイム計算<br>3. アイコン付きカード表示 |

#### 4.4.3 データエクスポート（REQ-MYPAGE-003）
**優先度**: 🟡 推奨

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーの全データをJSON形式でエクスポートできる |
| **処理** | 1. プロフィール、統計、チャット履歴をDBから取得<br>2. JSON形式に整形<br>3. ファイルダウンロード |
| **ファイル名** | `ramat_data_YYYYMMDD.json` |

#### 4.4.4 データ削除（REQ-MYPAGE-004）
**優先度**: 🔴 必須

| 項目 | 内容 |
|-----|------|
| **概要** | ユーザーの全データを完全削除できる |
| **処理** | 1. 確認ダイアログ表示（2回）<br>2. DBから全データ削除（CASCADE）<br>3. ログアウト<br>4. ログインページへリダイレクト |
| **削除対象** | - ソウルメイト<br>- チャット履歴<br>- 統計情報<br>- ユーザーアカウント |

---

### 4.5 管理者機能

#### 4.5.1 統計ダッシュボード（REQ-ADMIN-001）
**優先度**: 🟡 推奨

| 項目 | 内容 |
|-----|------|
| **概要** | システム全体の統計情報をダッシュボードで表示する |
| **表示項目** | - 総生成数<br>- 総ユーザー数<br>- 今日の生成数<br>- 週間生成数グラフ（Chart.js）<br>- 人気動物TOP 5<br>- 最近の生成履歴 |
| **更新頻度** | 30秒ごとに自動更新 |
| **アクセス制御** | 管理者メールアドレスのみアクセス可 |

**管理者判定:**
```javascript
const adminEmails = ['admin@ramat.app', 'test@ramat.app'];
```

#### 4.5.2 生成履歴管理（REQ-ADMIN-002）
**優先度**: 🟢 オプション

| 項目 | 内容 |
|-----|------|
| **概要** | 全ユーザーの生成履歴を一覧表示・管理できる |
| **表示項目** | - ユーザーID<br>- 生成日時<br>- 動物種<br>- 名前 |
| **機能** | - ソート（日付、動物種）<br>- 検索<br>- ページネーション（50件/ページ） |

---

### 4.6 壁紙生成機能（将来実装）

#### 4.6.1 壁紙生成（REQ-WALL-001）
**優先度**: 🟢 オプション

| 項目 | 内容 |
|-----|------|
| **概要** | ソウルメイトをモチーフにしたオリジナル壁紙を生成できる |
| **種類** | - スマートフォン用（1080x1920px）<br>- PC用（1920x1080px） |
| **処理** | 1. 生成リクエスト<br>2. Gemini APIで壁紙画像生成<br>3. R2に保存<br>4. ダウンロードリンク提供 |
| **課金** | Premium会員: 無料<br>Free会員: ¥500/枚 |

---

## 5. 非機能要件

### 5.1 性能要件

#### 5.1.1 応答時間（REQ-PERF-001）
**優先度**: 🔴 必須

| 操作 | 目標応答時間 | 最大許容時間 |
|-----|------------|-------------|
| **ページロード（初回）** | < 2秒 | 3秒 |
| **ページロード（2回目以降）** | < 1秒 | 1.5秒 |
| **ログイン処理** | < 1秒 | 2秒 |
| **チャットメッセージ送信** | < 3秒 | 5秒 |
| **ソウルメイト生成** | < 10秒 | 15秒 |
| **API レスポンス** | < 500ms | 1秒 |

#### 5.1.2 スループット（REQ-PERF-002）
**優先度**: 🔴 必須

| 項目 | Year 1 | Year 2 | Year 3 |
|-----|--------|--------|--------|
| **同時接続数** | 1,000 | 10,000 | 50,000 |
| **API リクエスト/秒** | 100 | 500 | 2,000 |
| **メッセージ処理/日** | 50,000 | 500,000 | 2,000,000 |

#### 5.1.3 リソース使用量（REQ-PERF-003）
**優先度**: 🟡 推奨

| リソース | 目標値 |
|---------|-------|
| **バンドルサイズ** | < 500KB（圧縮後） |
| **メモリ使用量（Worker）** | < 128MB |
| **DB接続プール** | 10-50接続 |

### 5.2 可用性要件

#### 5.2.1 稼働率（REQ-AVAIL-001）
**優先度**: 🔴 必須

| 項目 | 目標値 |
|-----|-------|
| **年間稼働率** | 99.9%（ダウンタイム < 8.76時間/年） |
| **計画メンテナンス** | 月1回、深夜帯、30分以内 |
| **障害復旧時間（MTTR）** | < 1時間 |

#### 5.2.2 冗長化（REQ-AVAIL-002）
**優先度**: 🟡 推奨

- Cloudflare Workersによる自動スケーリング
- マルチリージョン展開（200+都市）
- 自動フェイルオーバー

### 5.3 スケーラビリティ要件

#### 5.3.1 水平スケーリング（REQ-SCALE-001）
**優先度**: 🔴 必須

| 指標 | 現在 | Year 1 | Year 2 | Year 3 |
|-----|-----|--------|--------|--------|
| **ユーザー数** | - | 15,500 | 80,000 | 250,000 |
| **DBレコード数** | - | 100K | 500K | 2M |
| **ストレージ** | - | 10GB | 100GB | 500GB |

#### 5.3.2 垂直スケーリング（REQ-SCALE-002）
**優先度**: 🟢 オプション

- D1 Databaseの自動スケーリング
- R2ストレージの無制限拡張

### 5.4 保守性要件

#### 5.4.1 コード品質（REQ-MAINT-001）
**優先度**: 🔴 必須

| 項目 | 基準 |
|-----|-----|
| **TypeScript使用率** | 100%（バックエンド） |
| **コメント率** | 主要関数に説明コメント必須 |
| **命名規則** | キャメルケース（JS）、ケバブケース（CSS） |
| **ファイル分割** | 1ファイル < 500行 |

#### 5.4.2 テスト（REQ-MAINT-002）
**優先度**: 🟡 推奨

| テストタイプ | カバレッジ目標 |
|-----------|-------------|
| **APIテスト** | 80%以上 |
| **E2Eテスト** | 主要フロー全て |
| **回帰テスト** | デプロイ前必須 |

#### 5.4.3 ドキュメント（REQ-MAINT-003）
**優先度**: 🔴 必須

- README.md（プロジェクト概要）
- REQUIREMENTS.md（本文書）
- API仕様書
- デプロイ手順書

### 5.5 互換性要件

#### 5.5.1 ブラウザ対応（REQ-COMPAT-001）
**優先度**: 🔴 必須

| ブラウザ | 対応バージョン | 動作保証 |
|---------|-------------|---------|
| **Chrome** | 最新版 + 2バージョン | ✅ 完全対応 |
| **Safari** | 最新版 + 2バージョン | ✅ 完全対応 |
| **Firefox** | 最新版 + 2バージョン | ✅ 完全対応 |
| **Edge** | 最新版 + 2バージョン | ✅ 完全対応 |
| **Safari (iOS)** | iOS 14+ | ✅ 完全対応 |
| **Chrome (Android)** | Android 9+ | ✅ 完全対応 |

#### 5.5.2 デバイス対応（REQ-COMPAT-002）
**優先度**: 🔴 必須

| デバイス | 解像度 | 対応状況 |
|---------|-------|---------|
| **スマートフォン** | 375px～ | ✅ モバイルファースト |
| **タブレット** | 768px～ | ✅ 最適化済み |
| **デスクトップ** | 1024px～ | ✅ レスポンシブ対応 |

### 5.6 ユーザビリティ要件

#### 5.6.1 アクセシビリティ（REQ-USAB-001）
**優先度**: 🟡 推奨

- WCAG 2.1 レベルAA準拠
- キーボード操作対応
- スクリーンリーダー対応（将来実装）

#### 5.6.2 国際化（REQ-USAB-002）
**優先度**: 🟢 オプション（Year 2以降）

- 多言語対応（英語、韓国語、中国語）
- タイムゾーン対応
- 通貨表示切替

---

## 6. データ要件

### 6.1 データモデル

#### 6.1.1 users テーブル
**目的**: ユーザーアカウント情報を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|-----|
| id | TEXT | PK | ユーザー一意識別子（UUID） |
| email | TEXT | UNIQUE | メールアドレス |
| password_hash | TEXT | NOT NULL | パスワードハッシュ（SHA-256） |
| username | TEXT | NOT NULL | 表示名（2-20文字） |
| email_verified | INTEGER | DEFAULT 0 | メール認証フラグ（0:未, 1:済） |
| created_at | DATETIME | DEFAULT NOW | 登録日時 |
| last_active_at | DATETIME | DEFAULT NOW | 最終アクティブ日時 |

**インデックス:**
- `idx_users_email` ON email

#### 6.1.2 soulmates テーブル
**目的**: 生成されたソウルメイト情報を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|-----|
| id | INTEGER | PK AUTO_INCREMENT | ソウルメイトID |
| user_id | TEXT | FK(users.id) ON DELETE CASCADE | 所有ユーザー |
| name | TEXT | NOT NULL | ソウルメイトの名前 |
| concept | TEXT | NOT NULL | コンセプト（例: 星影のホッキョクオオカミ） |
| personality | TEXT | NOT NULL | 性格詳細説明 |
| tone | TEXT | NOT NULL | 口調・話し方説明 |
| animal | TEXT | NOT NULL | 動物種（日本語） |
| image_base64 | TEXT | NOT NULL | 画像データ（Base64） |
| created_at | DATETIME | DEFAULT NOW | 生成日時 |

**インデックス:**
- `idx_soulmates_user_id` ON user_id

#### 6.1.3 chat_messages テーブル
**目的**: チャット履歴を保存

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|-----|
| id | INTEGER | PK AUTO_INCREMENT | メッセージID |
| user_id | TEXT | FK(users.id) ON DELETE CASCADE | ユーザーID |
| soulmate_id | INTEGER | FK(soulmates.id) ON DELETE CASCADE | ソウルメイトID |
| sender | TEXT | CHECK IN ('user', 'soulmate') | 送信者 |
| message | TEXT | NOT NULL | メッセージ本文 |
| created_at | DATETIME | DEFAULT NOW | 送信日時 |

**インデックス:**
- `idx_chat_messages_user_id` ON user_id
- `idx_chat_messages_soulmate_id` ON soulmate_id
- `idx_chat_messages_created_at` ON created_at DESC

#### 6.1.4 user_stats テーブル
**目的**: ユーザー統計情報を管理

| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|-----|
| user_id | TEXT | PK, FK(users.id) ON DELETE CASCADE | ユーザーID |
| total_messages | INTEGER | DEFAULT 0 | 総メッセージ数 |
| total_conversations | INTEGER | DEFAULT 0 | 総会話数 |
| favorite_count | INTEGER | DEFAULT 0 | お気に入り数 |
| last_updated_at | DATETIME | DEFAULT NOW | 最終更新日時 |

### 6.2 データ保持ポリシー

#### 6.2.1 データ保存期間（REQ-DATA-001）
**優先度**: 🔴 必須

| データ種別 | 保存期間 | 削除タイミング |
|----------|---------|--------------|
| **ユーザーアカウント** | 無期限 | ユーザーが削除リクエスト |
| **チャット履歴** | 無期限 | ユーザーが削除リクエスト |
| **統計情報** | 無期限 | ユーザーが削除リクエスト |
| **セッション（JWT）** | 30日 | 有効期限切れで自動削除 |

#### 6.2.2 バックアップ（REQ-DATA-002）
**優先度**: 🔴 必須

| 項目 | 設定値 |
|-----|-------|
| **自動バックアップ** | 毎日1回（深夜3時JST） |
| **保存世代数** | 7世代（7日分） |
| **バックアップ先** | Cloudflare D1自動バックアップ |
| **復旧テスト** | 月1回実施 |

### 6.3 データセキュリティ

#### 6.3.1 暗号化（REQ-DATA-SEC-001）
**優先度**: 🔴 必須

| 項目 | 暗号化方式 |
|-----|----------|
| **通信** | TLS 1.3 |
| **パスワード** | SHA-256 + Salt |
| **DB保存データ** | Cloudflare D1標準暗号化 |

#### 6.3.2 個人情報保護（REQ-DATA-SEC-002）
**優先度**: 🔴 必須

- GDPR準拠
- 個人情報保護法準拠
- プライバシーポリシー明示
- データエクスポート機能提供
- データ完全削除機能提供

---

## 7. 外部インターフェース要件

### 7.1 外部API連携

#### 7.1.1 Google Gemini API（REQ-EXT-001）
**優先度**: 🔴 必須

| 項目 | 詳細 |
|-----|-----|
| **プロバイダー** | Google Cloud |
| **エンドポイント** | `https://generativelanguage.googleapis.com/v1beta/` |
| **認証** | API Key（環境変数） |
| **使用モデル** | - gemini-2.0-flash-exp（テキスト）<br>- gemini-2.5-flash-image（画像） |
| **レート制限** | 60 RPM（Requests Per Minute） |
| **エラーハンドリング** | - 429: レート制限 → リトライ（Exponential Backoff）<br>- 500: サーバーエラー → ユーザーに通知 |

#### 7.1.2 Resend API（メール送信）（REQ-EXT-002）
**優先度**: 🟡 推奨（メール認証実装時）

| 項目 | 詳細 |
|-----|-----|
| **プロバイダー** | Resend |
| **用途** | メール認証、パスワードリセット |
| **認証** | API Key |
| **レート制限** | 100通/時間 |

### 7.2 Cloudflareサービス連携

#### 7.2.1 Cloudflare D1（REQ-EXT-003）
**優先度**: 🔴 必須

| 項目 | 詳細 |
|-----|-----|
| **接続方式** | Binding（環境変数） |
| **接続プール** | 自動管理 |
| **クエリタイムアウト** | 30秒 |

#### 7.2.2 Cloudflare R2（REQ-EXT-004）
**優先度**: 🟡 推奨（壁紙機能実装時）

| 項目 | 詳細 |
|-----|-----|
| **接続方式** | S3互換API |
| **用途** | 壁紙画像保存 |
| **バケット名** | `ramat-wallpapers` |

---

## 8. セキュリティ要件

### 8.1 認証・認可

#### 8.1.1 パスワードポリシー（REQ-SEC-001）
**優先度**: 🔴 必須

| 項目 | 要件 |
|-----|-----|
| **最小文字数** | 8文字 |
| **文字種** | 英数字を含む |
| **ハッシュアルゴリズム** | SHA-256 + Salt |
| **ソルト生成** | ランダム生成（32バイト） |

#### 8.1.2 セッション管理（REQ-SEC-002）
**優先度**: 🔴 必須

| 項目 | 設定 |
|-----|-----|
| **トークン形式** | JWT |
| **有効期限** | 30日 |
| **保存方式** | HTTP-only Cookie |
| **SameSite** | Strict |
| **Secure** | true（HTTPS必須） |

### 8.2 脆弱性対策

#### 8.2.1 XSS対策（REQ-SEC-003）
**優先度**: 🔴 必須

- Content Security Policy (CSP) 設定
- ユーザー入力のサニタイズ
- HTMLエスケープ処理

#### 8.2.2 CSRF対策（REQ-SEC-004）
**優先度**: 🔴 必須

- トークンベース認証（JWT）
- SameSite Cookie属性
- Originヘッダー検証

#### 8.2.3 SQLインジェクション対策（REQ-SEC-005）
**優先度**: 🔴 必須

- パラメータ化クエリ使用
- ORMレイヤーでの自動エスケープ

### 8.3 監視・ログ

#### 8.3.1 ログ記録（REQ-SEC-006）
**優先度**: 🟡 推奨

| ログ種別 | 記録内容 | 保存期間 |
|---------|---------|---------|
| **アクセスログ** | URL、ユーザーID、タイムスタンプ | 30日 |
| **エラーログ** | エラー内容、スタックトレース | 90日 |
| **セキュリティログ** | ログイン失敗、不正アクセス | 180日 |

#### 8.3.2 異常検知（REQ-SEC-007）
**優先度**: 🟡 推奨

- 短時間の大量ログイン試行検知
- 異常なAPIリクエスト頻度検知
- DDoS攻撃検知（Cloudflare WAF）

---

## 9. 画面要件

### 9.1 ログイン/新規登録画面

#### 9.1.1 レイアウト（REQ-UI-001）

```
┌─────────────────────────────────────┐
│         🌸 Ramat 🌸                 │
│    あなただけの守護動物               │
├─────────────────────────────────────┤
│  [ログイン] [新規登録]  ← タブ切替   │
├─────────────────────────────────────┤
│  📧 メールアドレス                    │
│  [                    ]              │
│                                     │
│  🔒 パスワード                        │
│  [                    ]              │
│                                     │
│  (新規登録時のみ)                     │
│  👤 ユーザー名                        │
│  [                    ]              │
│                                     │
│    [ ログイン / 登録する ]           │
│                                     │
│  Google でログイン 🔗（将来実装）     │
└─────────────────────────────────────┘
```

**カラースキーム:**
- 背景: 桜色グラデーション（#FFB6C1 → #FF85A1）
- ボタン: ピンク（#FF69B4）
- テキスト: ダークグレー（#333）

### 9.2 チャット画面

#### 9.2.1 レイアウト（REQ-UI-002）

```
┌─────────────────────────────────────┐
│  ┌──────┐                           │
│  │画像  │ ソウルメイト名              │
│  │200px │ 動物種                     │
│  └──────┘                           │
│  (スクロール後 → 60px に縮小)        │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────┐                    │
│  │こんにちは！  │ ← ソウルメイト      │
│  └─────────────┘                    │
│                                     │
│               ┌─────────────┐       │
│               │元気だよ！    │ ← ユーザー│
│               └─────────────┘       │
│                                     │
│  ┌─────────────┐                    │
│  │それは良かった│ ← ソウルメイト      │
│  └─────────────┘                    │
│                                     │
├─────────────────────────────────────┤
│  [メッセージを入力...        ] [送信]│
└─────────────────────────────────────┘
│  [ホーム] [チャット] [ストア] [マイページ] [ログアウト]
└─────────────────────────────────────┘
```

### 9.3 マイページ画面

#### 9.3.1 レイアウト（REQ-UI-003）

```
┌─────────────────────────────────────┐
│        マイページ                    │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │    ソウルメイトプロフィール   │    │
│  │  ┌──────┐                   │    │
│  │  │画像  │ 名前: アキラ       │    │
│  │  └──────┘ コンセプト: ...    │    │
│  │          動物: 北極オオカミ   │    │
│  │          出会って: 5日目     │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │        統計情報              │    │
│  │  💬 会話数: 42               │    │
│  │  📅 出会った日数: 5日         │    │
│  │  ⭐ お気に入り: 0            │    │
│  └─────────────────────────────┘    │
│                                     │
│  [ データエクスポート ]              │
│  [ データ削除 ]                     │
└─────────────────────────────────────┘
│  [ホーム] [チャット] [ストア] [マイページ] [ログアウト]
└─────────────────────────────────────┘
```

### 9.4 管理者ダッシュボード

#### 9.4.1 レイアウト（REQ-UI-004）

```
┌─────────────────────────────────────┐
│      管理者ダッシュボード             │
├─────────────────────────────────────┤
│  [総生成数]  [ユーザー数]  [今日の生成]│
│    1,234      567        42         │
├─────────────────────────────────────┤
│        週間生成数グラフ               │
│   ┌──────────────────────┐          │
│   │ ▂▃▅▇█▇▅ (Chart.js)   │          │
│   └──────────────────────┘          │
├─────────────────────────────────────┤
│       人気動物 TOP 5                 │
│   1. 北極オオカミ ████████ 120      │
│   2. レッサーパンダ ██████ 95       │
│   3. ユキヒョウ ████ 78             │
└─────────────────────────────────────┘
```

---

## 10. API要件

### 10.1 認証API

#### 10.1.1 POST /api/auth/register（REQ-API-001）
**新規ユーザー登録**

**リクエスト:**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "username": "太郎"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "user": {
    "id": "user_abc123",
    "email": "user@example.com",
    "username": "太郎",
    "createdAt": "2025-12-14T12:00:00.000Z"
  }
}
```

**レスポンス（エラー）:**
```json
{
  "success": false,
  "error": "Email already exists"
}
```

**ステータスコード:**
- 200: 成功
- 400: バリデーションエラー
- 409: メールアドレス重複
- 500: サーバーエラー

#### 10.1.2 POST /api/auth/login（REQ-API-002）
**ユーザーログイン**

**リクエスト:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "user": {
    "id": "user_abc123",
    "email": "user@example.com",
    "username": "太郎"
  }
}
```

**ステータスコード:**
- 200: 成功
- 400: バリデーションエラー
- 401: 認証失敗
- 500: サーバーエラー

#### 10.1.3 POST /api/auth/logout（REQ-API-003）
**ログアウト**

**レスポンス:**
```json
{
  "success": true
}
```

**ステータスコード:**
- 200: 成功

#### 10.1.4 GET /api/auth/me（REQ-API-004）
**現在のユーザー情報取得**

**レスポンス:**
```json
{
  "success": true,
  "user": {
    "id": "user_abc123",
    "email": "user@example.com",
    "username": "太郎",
    "createdAt": "2025-12-14T12:00:00.000Z"
  }
}
```

**ステータスコード:**
- 200: 成功
- 401: 未認証

### 10.2 生成API

#### 10.2.1 POST /api/generate（REQ-API-005）
**ソウルメイト生成**

**リクエスト:**
```json
{
  "userId": "user_abc123"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "animal": {
    "en": "arctic wolf",
    "ja": "北極オオカミ"
  },
  "profile": {
    "concept": "星影のホッキョクオオカミ",
    "name": "アキラ",
    "personality": "物静かで穏やかな性格...",
    "tone": "静かで優しい語り口...",
    "image": "data:image/png;base64,..."
  }
}
```

**処理時間:** 平均8-10秒

**ステータスコード:**
- 200: 成功
- 401: 未認証
- 409: 既にソウルメイト存在
- 500: 生成エラー

### 10.3 チャットAPI

#### 10.3.1 POST /api/chat/send（REQ-API-006）
**メッセージ送信**

**リクエスト:**
```json
{
  "userId": "user_abc123",
  "message": "今日は疲れたよ"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "reply": "そうなんだね、お疲れ様。ゆっくり休んでね✨",
  "timestamp": "2025-12-14T12:30:00.000Z"
}
```

**処理時間:** 平均2-3秒

**ステータスコード:**
- 200: 成功
- 401: 未認証
- 400: メッセージが空
- 500: AI生成エラー

### 10.4 マイページAPI

#### 10.4.1 GET /api/mypage/profile/:userId（REQ-API-007）
**プロフィール取得**

**レスポンス:**
```json
{
  "success": true,
  "profile": {
    "id": 123,
    "name": "アキラ",
    "concept": "星影のホッキョクオオカミ",
    "personality": "...",
    "tone": "...",
    "animal": "北極オオカミ",
    "image": "data:image/png;base64,...",
    "createdAt": "2025-12-10T12:00:00.000Z"
  }
}
```

#### 10.4.2 GET /api/mypage/stats/:userId（REQ-API-008）
**統計情報取得**

**レスポンス:**
```json
{
  "success": true,
  "stats": {
    "totalMessages": 42,
    "totalConversations": 5,
    "favoriteCount": 0,
    "daysSince": 5,
    "lastChatDate": "2025-12-14T12:00:00.000Z"
  }
}
```

#### 10.4.3 GET /api/mypage/history/:userId?limit=50（REQ-API-009）
**チャット履歴取得**

**レスポンス:**
```json
{
  "success": true,
  "history": [
    {
      "id": 1,
      "sender": "user",
      "message": "こんにちは",
      "created_at": "2025-12-14T12:00:00.000Z"
    },
    {
      "id": 2,
      "sender": "soulmate",
      "message": "こんにちは！今日はどう？",
      "created_at": "2025-12-14T12:00:05.000Z"
    }
  ]
}
```

---

## 11. 制約事項

### 11.1 技術的制約

| 項目 | 制約内容 |
|-----|---------|
| **Cloudflare Workers制限** | CPU時間: 10ms（Free）/ 30ms（Paid） |
| **D1 Database制限** | 1DBあたり10GBまで |
| **R2 Storage制限** | 無制限（従量課金） |
| **Gemini API制限** | 60 RPM（無料枠）、1,500 RPD |
| **バンドルサイズ** | Workerは10MB以内（圧縮後） |

### 11.2 ビジネス制約

| 項目 | 制約内容 |
|-----|---------|
| **Free プラン制限** | チャット10回/日まで |
| **画像サイズ** | ソウルメイト画像: 512x512px |
| **メッセージ長** | 1-500文字 |
| **プロフィール文字数** | 最大2,000文字 |

### 11.3 運用制約

| 項目 | 制約内容 |
|-----|---------|
| **メンテナンス時間** | 月1回、深夜2-3時（JST）、30分以内 |
| **サポート対応時間** | 平日10-18時（JST） |
| **データ保持期間** | アカウント削除から30日間はバックアップ保持 |

---

## 12. 用語集

| 用語 | 説明 |
|-----|------|
| **ソウルメイト** | AIが生成する、ユーザー固有の守護動物キャラクター |
| **コンセプト** | ソウルメイトの特徴を表す短いフレーズ（例: 星影のホッキョクオオカミ） |
| **WAU** | Weekly Active Users（週間アクティブユーザー数） |
| **MAU** | Monthly Active Users（月間アクティブユーザー数） |
| **DAU** | Daily Active Users（日間アクティブユーザー数） |
| **D7リテンション** | 登録後7日目のユーザー継続率 |
| **NPS** | Net Promoter Score（顧客推奨度） |
| **ARPU** | Average Revenue Per User（ユーザー平均単価） |
| **LTV** | Lifetime Value（顧客生涯価値） |
| **CAC** | Customer Acquisition Cost（顧客獲得コスト） |
| **JWT** | JSON Web Token（認証トークン形式） |
| **D1** | Cloudflareのエッジ対応SQLiteデータベース |
| **R2** | CloudflareのS3互換オブジェクトストレージ |
| **Workers** | Cloudflareのサーバーレスコンピューティングプラットフォーム |
| **Gemini API** | GoogleのマルチモーダルAI APIサービス |

---

## 付録

### A. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|-----|---------|-------|
| 1.0 | 2025-12-14 | 初版作成 | AI Assistant |

### B. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|-----|-----|-------|------|
| プロダクトマネージャー | - | - | - |
| 技術責任者 | - | - | - |
| QA責任者 | - | - | - |

---

**本要件定義書は、Ramatプロジェクトの公式仕様書です。**  
**変更がある場合は、必ず承認プロセスを経てバージョン管理を行ってください。**

**Last Updated**: 2025年12月14日  
**Status**: ✅ MVP実装完了  
**Production URL**: https://ramat.pages.dev
